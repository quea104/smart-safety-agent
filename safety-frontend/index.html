<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¼ì„±ë¬¼ì‚° ê±´ì„¤ ì•ˆì „ AI Agent (Final)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 80vh; }
        h2 { color: #004c97; text-align: center; margin-bottom: 10px; font-weight: bold; }
        .chat-window { flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background-color: #fff; margin-bottom: 15px; }
        .message { margin-bottom: 15px; padding: 12px 18px; border-radius: 15px; max-width: 80%; line-height: 1.6; font-size: 15px; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message-content { white-space: pre-wrap; }
        .message-content strong { color: #d63384; font-weight: 900; background-color: #fff0f6; padding: 0 4px; border-radius: 4px; }
        .role-badge { display: block; font-size: 11px; font-weight: bold; margin-bottom: 6px; opacity: 0.7; }
        .user { background-color: #004c97; color: white !important; margin-left: auto; text-align: right; border-bottom-right-radius: 0; }
        .user .role-badge { color: #ddd; }
        .ai { background-color: #e9ecef; color: #333 !important; margin-right: auto; text-align: left; border-bottom-left-radius: 0; }
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 15px; }
        button { padding: 10px 20px; background-color: #004c97; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .debug-info { font-size: 11px; color: red; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="app" class="container">
        <h2>ğŸ—ï¸ ê±´ì„¤ ì•ˆì „ ì±—ë´‡</h2>
        
        <div class="chat-window" ref="chatWindow">
            <div v-if="messages.length === 0" style="text-align: center; color: #888; margin-top: 50px;">
                ê¶ê¸ˆí•œ ì•ˆì „ ìˆ˜ì¹™ì„ ë¬¼ì–´ë³´ì„¸ìš”.<br><small>(ì˜ˆ: êµ´ì°© ì‘ì—… ì‹œ ì£¼ì˜ì‚¬í•­ì€?)</small>
            </div>
            
            <div v-for="(msg, index) in messages" :key="index" :class="['message', msg.role]">
                <span class="role-badge">
                    {{ msg.role === 'user' ? 'ğŸ§‘â€ğŸ’» ë‚˜' : 'ğŸ¤– AI ì•ˆì „ ë¹„ì„œ' }}
                </span>
                
                <div class="message-content" v-html="formatMessage(msg.text)"></div>
            </div>
        </div>

        <div class="input-area">
            <input v-model="userInput" @keyup.enter="sendMessage" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." :disabled="loading">
            <button @click="sendMessage" :disabled="loading">ì „ì†¡</button>
        </div>
        <div v-if="loading" class="debug-info">AIê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const userInput = ref('');
                const messages = ref([]);
                const loading = ref(false);
                const chatWindow = ref(null);

                // [í•µì‹¬ ê¸°ëŠ¥] **í…ìŠ¤íŠ¸** ë¥¼ êµµê²Œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
                const formatMessage = (text) => {
                    if (!text) return '';
                    // ì •ê·œì‹ìœ¼ë¡œ **...** íŒ¨í„´ì„ ì°¾ì•„ <strong> íƒœê·¸ë¡œ ê°ì‹¸ê¸°
                    return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                };

                const scrollToBottom = async () => {
                    await nextTick();
                    if (chatWindow.value) {
                        chatWindow.value.scrollTop = chatWindow.value.scrollHeight;
                    }
                };

                const sendMessage = async () => {
                    if (!userInput.value.trim()) return;

                    const query = userInput.value;
                    messages.value.push({ role: 'user', text: query });
                    userInput.value = '';
                    loading.value = true;
                    scrollToBottom();

                    try {
                        const response = await axios.post('http://localhost:8080/api/safety/query', {
                            query: query
                        });

                        const aiAnswer = response.data.answer || "ì‘ë‹µ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                        messages.value.push({ role: 'ai', text: aiAnswer });

                    } catch (error) {
                        console.error("ì—ëŸ¬:", error);
                        messages.value.push({ role: 'ai', text: 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.' });
                    } finally {
                        loading.value = false;
                        scrollToBottom();
                    }
                };

                // formatMessageë¥¼ ê¼­ ë°˜í™˜í•´ì•¼ HTMLì—ì„œ ì‚¬ìš© ê°€ëŠ¥
                return { userInput, messages, loading, sendMessage, chatWindow, formatMessage };
            }
        }).mount('#app');
    </script>
</body>
</html>